{% extends "base.html" %}
{% block title %}Converta EXCEL para PDF{% endblock %}

{% block content %}
<section class="py-5" style="background: #f7f8fa; min-height: 80vh;">
    <div class="container text-center">
        <div class="mb-4">
            <i class="fas fa-file-pdf" style="font-size: 6rem; color: #dc3545;"></i>
        </div>
        <h1 class="fw-bold mb-3" style="font-size:2.5rem;">Converta EXCEL para PDF</h1>
        <p class="mb-2 text-muted" style="font-size:1.2rem;">
            Converta as suas folhas de cálculo EXCEL (.xls, .xlsx) para PDF com precisão.
        </p>
        <div class="d-flex justify-content-center align-items-center mb-2 gap-2">
            <button type="button" class="btn btn-lg px-5 py-3 text-white" id="selectFileBtn"
                style="background:#1D6F42; color:#fff; font-size:1.3rem; border-radius:16px; box-shadow:0 2px 8px #0001;">
                <i class="fas fa-file-excel me-2"></i>Selecionar arquivo EXCEL
            </button>
        </div>
        <div class="mb-4 text-muted" style="font-size:1rem;">
            ou <span style="text-decoration:underline;">arraste e solte o ficheiro em qualquer lugar da página</span>
        </div>
        <input type="file" id="excelFile" name="file" accept=".xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" style="display:none;">
        
        <div id="fileInfoArea" class="d-none">
            <span id="fileName" class="text-secondary d-block mb-3"></span>
            <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
                <button id="convertBtn" class="btn btn-lg px-5" style="background-color: #dc3545; border-color: #dc3545; color: #fff;">
                    <i class="fas fa-file-pdf me-2"></i>Converter para PDF
                </button>
                <button id="resetBtn" class="btn btn-secondary btn-lg px-5">
                    <i class="fas fa-times me-2"></i>Outro ficheiro
                </button>
            </div>
        </div>

        <div class="progress mt-3 mx-auto" style="height: 25px; max-width:500px; display:none;" id="progressBarContainer">
            <div class="progress-bar progress-bar-striped progress-bar-animated bg-danger" id="progressBar" style="width: 0%">0%</div>
        </div>
        <div id="resultArea" class="mt-4"></div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
const fileInput = document.getElementById('excelFile');
const selectFileBtn = document.getElementById('selectFileBtn');
const convertBtn = document.getElementById('convertBtn');
const fileNameSpan = document.getElementById('fileName');
const resetBtn = document.getElementById('resetBtn');
const fileInfoArea = document.getElementById('fileInfoArea');
let selectedFile = null;

// Seleção manual
selectFileBtn.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', handleFileChange);

// Drag & Drop global
document.body.addEventListener('dragover', function(e) { e.preventDefault(); });
document.body.addEventListener('drop', function(e) {
    e.preventDefault();
    if (e.dataTransfer.files.length) {
        fileInput.files = e.dataTransfer.files;
        handleFileChange();
    }
});

function handleFileChange() {
    selectedFile = fileInput.files[0];
    if (selectedFile) {
        selectFileBtn.parentElement.parentElement.style.display = 'none';
        fileInfoArea.classList.remove('d-none');
        fileNameSpan.textContent = selectedFile.name + " pronto para converter";
    }
}

// Conversão
convertBtn.addEventListener('click', function() {
    if (!selectedFile) return;
    convertBtn.disabled = true;
    resetBtn.disabled = true;
    document.getElementById('resultArea').innerHTML = '';
    const progressBarContainer = document.getElementById('progressBarContainer');
    const progressBar = document.getElementById('progressBar');
    progressBarContainer.style.display = 'block';
    progressBar.style.width = '0%';
    progressBar.textContent = '0%';

    const formData = new FormData();
    formData.append('file', selectedFile);

    // A URL aponta para a nova view que vamos criar
    fetch("{% url 'converter:excel_to_pdf' %}", {
        method: "POST",
        body: formData,
        headers: { "X-CSRFToken": "{{ csrf_token }}" }
    })
    .then(response => response.json())
    .then(data => {
        progressBar.style.width = '100%';
        progressBar.textContent = '100%';
        if (data.success) {
            document.getElementById('resultArea').innerHTML = `
                <div class="alert alert-success">Conversão realizada! <a href="${data.download_url}" class="btn btn-success" download="${data.file_name || ''}">Baixar PDF</a></div>
            `;
        } else {
            document.getElementById('resultArea').innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
        }
    })
    .catch(() => {
        document.getElementById('resultArea').innerHTML = `<div class="alert alert-danger">Erro ao converter o arquivo.</div>`;
    })
    .finally(() => {
        convertBtn.disabled = false;
        resetBtn.disabled = false;
        setTimeout(() => {
            progressBarContainer.style.display = 'none';
        }, 1500);
    });
});

// Lógica para o botão de reset
resetBtn.addEventListener('click', function() {
    location.reload();
});
</script>
{% endblock %}